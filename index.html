<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Web ERG Trainer</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.cyan.min.css"
    />
    <link rel="stylesheet" href="./main.css" />
  </head>
  <body>
    <main class="container" x-data="workoutApp()">
      <form @submit.prevent="startWorkout" x-data x-show="showForm">
        <fieldset>
          <label
            >Vélo
            <input
              type="button"
              @click="connectErgo"
              :disabled="ergometerName"
              x-bind:value="ergometerButtonLabel"
            />
          </label>
          <label
            >Cardio
            <input
              type="button"
              @click="connectHeartRateMonitor"
              :disabled="heartRateMonitorName"
              x-bind:value="heartRateMonitorButtonLabel"
            />
          </label>
          <label
            >FTP (watts)
            <input
              type="number"
              min="50"
              max="500"
              step="5"
              x-model="ftp"
              placeholder="150"
            />
            <small>
              Functional Threshold Power - utilisé pour calculer les intensités
              de l'entraînement
            </small>
          </label>
          <label
            >Poids (kg)
            <input
              type="number"
              min="40"
              max="150"
              step="1"
              x-model="weight"
              placeholder="70"
            />
            <small>
              Poids du cycliste - utilisé pour calculer la vitesse virtuelle
            </small>
          </label>
          <label> Entraînement</label>
          <div class="grid">
            <button
              type="button"
              class="outline"
              onclick="libraryModal.showModal()"
            >
              Choisir dans la bibliothèque
            </button>
            <input
              type="file"
              accept=".zwo,.xml"
              @change="onZwoFileChange"
              x-ref="fileInput"
              style="display: none"
              name="workoutFile"
            />
            <button
              type="button"
              class="outline"
              @click="$refs.fileInput.click()"
            >
              Charger un fichier
            </button>
          </div>
          <small>
            <span x-show="!selectedWorkout">
              Fichier d'entraînement au format ZWO
              <a class="secondary" href="#" onclick="zwoModal.showModal()">
                ⓘ En savoir plus
              </a>
            </span>
            <span x-show="selectedWorkout">
              Sélectionné: <strong x-text="selectedWorkout?.name"></strong>
              <span x-show="selectedWorkout?.duration">
                (<span x-text="selectedWorkout?.duration"></span> min)
              </span>
            </span>
          </small>

          <dialog id="noBluetoothModal" x-bind:open="!navigator.bluetooth">
            <article>
              <header>
                <button
                  aria-label="Fermer"
                  rel="prev"
                  onclick="noBluetoothModal.close()"
                ></button>
                <p><strong>Bluetooth non supporté</strong></p>
              </header>
              <p>
                Ton navigateur ne supporte pas les connexions Bluetooth. Tu peux
                essayer avec
                <a href="https://caniuse.com/?search=bluetooth">
                  un autre navigateur</a
                >.
              </p>
            </article>
          </dialog>

          <dialog id="zwoModal">
            <article>
              <header>
                <h3>Qu'est-ce qu'un fichier ZWO ?</h3>
              </header>
              <p>
                Un fichier <strong>ZWO</strong> est un format XML utilisé pour
                décrire des entraînements structurés pour le cyclisme, notamment
                sur Zwift et d'autres plateformes d'entraînement. Il contient la
                séquence des intervalles, leur durée et leur intensité.
              </p>
              <ul>
                <li>Tu peux en choisir un dans la bibliothèque.</li>
                <li>
                  Tu peux aussi créer les tiens avec des éditeurs en ligne comme
                  <a href="https://zwofactory.com/" target="_blank"
                    >ZWO Factory</a
                  >
                  et les charger.
                </li>
              </ul>
              <footer>
                <button onclick="zwoModal.close()">Fermer</button>
              </footer>
            </article>
          </dialog>

          <dialog id="libraryModal" x-data="workoutLibraryModal()">
            <article>
              <header>
                <button
                  aria-label="Fermer"
                  rel="prev"
                  onclick="libraryModal.close()"
                ></button>
                <p><strong>Bibliothèque d'entraînements</strong></p>
              </header>

              <div>
                <input
                  type="search"
                  placeholder="Rechercher un entraînement..."
                  x-model="searchQuery"
                  @input="filterData"
                />
              </div>

              <template x-ref="workoutItemTemplate">
                <article>
                  <hgroup>
                    <div class="grid">
                      <h6>
                        <span x-text="workout.name"></span>
                        •
                        <span x-text="`${workout.duration} minutes`"></span>
                      </h6>
                      <button class="outline" @click="workout.onClick()">
                        Sélectionner
                      </button>
                    </div>
                    <div x-show="workout.showPath && workout.path">
                      <small class="secondary" x-text="workout.path"></small>
                    </div>
                  </hgroup>
                  <p
                    x-data="{clamp: 3}"
                    class="workout-description"
                    @click="clamp = clamp === 3 ? 100 : 3"
                    x-bind:style="`-webkit-line-clamp: ${clamp}`"
                  >
                    <span x-text="workout.description"></span>
                    <cite
                      x-show="workout.author"
                      x-text="` — ${workout.author}`"
                    ></cite>
                  </p>
                </article>
              </template>

              <div class="library-content">
                <template
                  x-for="(collection, collectionName) in displayData"
                  :key="collectionName"
                >
                  <details x-bind:open="!!searchQuery">
                    <summary>
                      <strong x-text="collectionName"></strong>
                      <small
                        x-text="`(${getCollectionCount(collection)} entraînements)`"
                      ></small>
                    </summary>
                    <div>
                      <template
                        x-for="(item, itemName) in collection"
                        :key="itemName"
                      >
                        <div>
                          <template x-if="isWorkoutFile(item)">
                            <div
                              x-data="{ workout: prepareWorkoutData(item, itemName, collectionName, false) }"
                              x-html="$refs.workoutItemTemplate.innerHTML"
                            ></div>
                          </template>
                          <template x-if="!isWorkoutFile(item)">
                            <details x-bind:open="!!searchQuery">
                              <summary x-text="itemName"></summary>
                              <div>
                                <template
                                  x-for="(subItem, subItemName) in item"
                                  :key="subItemName"
                                >
                                  <div
                                    x-data="{ workout: prepareWorkoutData(subItem, collectionName + '/' + itemName + '/' + subItemName, collectionName, true) }"
                                    x-html="$refs.workoutItemTemplate.innerHTML"
                                  ></div>
                                </template>
                              </div>
                            </details>
                          </template>
                        </div>
                      </template>
                    </div>
                  </details>
                </template>

                <div
                  x-show="searchQuery && Object.keys(displayData).length === 0"
                >
                  <p class="secondary">
                    Aucun entraînement trouvé pour "<span
                      x-text="searchQuery"
                    ></span
                    >"
                  </p>
                </div>
              </div>
            </article>
          </dialog>
          <button type="submit">Démarrer</button>
        </fieldset>
      </form>
      <div x-show="showWorkout">
        <hgroup>
          <h2>
            <span x-text="workoutMeta?.name"></span> •
            <span x-text="workoutMeta?.totalDuration"></span> minutes
          </h2>
          <p
            x-data="{clamp: 3}"
            class="workout-description"
            @click="clamp = clamp === 3 ? 100 : 3"
            x-bind:style="`-webkit-line-clamp: ${clamp}`"
          >
            <span x-text="workoutMeta?.description"></span>
            <cite
              x-show="workoutMeta?.author"
              x-text="` — ${workoutMeta?.author}`"
            ></cite>
          </p>
        </hgroup>

        <article x-show="isPaused" class="grid">
          <div>
            <h4>Entrainement en pause</h4>
            <p>
              Tu as mis l'entraînement en pause. Tu peux le reprendre en
              pédalant ou l'arrêter.
            </p>
          </div>
          <button class="outline" @click="stopWorkout">Arrêter</button>
        </article>

        <article x-show="workoutFinished" class="grid">
          <div>
            <h4>Entrainement terminé</h4>
            <p>
              Tu as terminé l'entraînement ! Tu peux maintenant exporter tes
              données et les
              <a href="https://www.strava.com/upload/select" target="_blank"
                >partager sur Strava</a
              >.
            </p>
          </div>
          <button @click="exportTcx">Exporter TCX</button>
        </article>

        <table>
          <thead>
            <tr>
              <th>Temps</th>
              <th>Puissance</th>
              <th>Cadence</th>
              <th>Cardio</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td x-text="timer">0:00</td>
              <td><span x-text="power">-</span> W</td>
              <td><span x-text="cadence">-</span> rpm</td>
              <td><span x-text="heartRate">-</span> bpm</td>
            </tr>
          </tbody>
        </table>
        <div class="phase-progress-container">
          <span x-text="phaseTimeRemaining">0:00</span>
          <progress x-bind:value="phaseProgress" max="100"></progress>
        </div>

        <div x-ref="workoutSvg" class="workout-svg-container"></div>
      </div>
    </main>
    <script type="module" src="js/main.js"></script>
    <script type="module" src="js/workout-library.js"></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
  </body>
</html>
